@import com.mbrdi.anita.basic.controller.StaticContent
@()

@views.html.basic.header("Trips","trips", "all trips")

<script src='@StaticContent.at("assets/plugins/angular/angular.min.js")'></script>

<div class="col-md-12">
	<div ng-controller="tripsCtl" ng-app="tripsApp">
		<div class="row margin-bottom-10" style="margin-top:5px;">
			<div class="col-md-2 pull-right">
				<div class="btn-group pull-right">
					<button type="button" class="btn-u btn-u-blue btn-u-sm dropdown-toggle" data-toggle="dropdown"> Action <i class="fa fa-angle-down"></i> </button>
					<ul class="dropdown-menu" role="menu">
						<li><a href="#" data-toggle="modal" data-target=".download-div">
							<i class="icon-cloud-download" style="font-size: 15px;"></i> Download
						</a></li>
					</ul>
				</div>
			</div>

			<div class="col-md-10">
				<div style="background-color: #f1f1f1; width:100%; padding: 5px 10px;">
					<div class="btn-group" role="group">
						<input type="text" class="btn btn-xs btn-default datepicker from_date" ng-model="from_date" placeholder="From Date" style="width: 80px" id="filter_from_date" ng-blur="filterAll()"/>
						<button type="button" class="btn btn-xs"><i class="fa fa-calendar"></i></button>
					</div>

					<button class="btn-u  btn-u-default  btn-u-xs pull-right margin-left-10" style="font-size: 7px;" ng-click="refreshGrid()"> <i class="icon-refresh"></i> </button>
					<button class="btn-u btn-u-blue btn-u-xs pull-right" ng-click="filterAll()"><i class="fa fa-filter"></i></button>
				</div>
			</div>
		</div>

		<div class="margin-bottom-10">
			<div class="row">
				<div class="col-md-4 col-sm-6 pull-right">
					<div class="btn-group pull-right" role="group">
						<label class="btn btn-default btn-u-sm" ng-click="prevPage()"><i class="fa fa-angle-double-left"></i></label>
						<label class="btn btn-default btn-u-sm" ng-cloak style="cursor:default; background-color:#fff">
							<span style="font-size:12px; ">Page </span><input type="text" class="btn btn-xs btn-default" ng-model="page" style="width: 40px;height:18px" ng-change="goTOPage()"/><span style="font-size:12px"> of {{total}}</span></label>
						<label class="btn btn-default btn-u-sm " ng-cloak style="cursor:default; background-color:#fff">
							<span style="font-size:12px;">Showing {{(page-1) * size +1 }} - {{(page-1)*size + trips.length}} of {{records}}</span>
						</label>
						<label class="btn btn-default btn-u-sm" ng-click="nextPage()"><i class="fa fa-angle-double-right"></i></label>
					</div>
				</div>

				<div class="margin-bottom-20"></div>
				<table class="table table-striped">
					<thead>
					<tr>
						<th></th>
						<th style="width:80px"><b>Date</b></th>
						<th><b>Detail</b></th>
						<th><b>Driver</b></th>
						<th><b>Travellers</b></th>
					</tr>
					</thead>
					<tbody>
					<tr ng-repeat="trip in trips">
						<td ng-cloak>
							<span class="badge rounded-2x badge-green" aria-label="Travelling Now"><i class="fa fa-car"></i></span>
						</td>
						<td ng-cloak>
							{{getDateFormatted(trip.date)}}
						</td>
						<td>
							<div class="btn-group" role="group">
								<button type="button" class="btn btn-xs btn-default" ng-cloak>{{trip.start_place| limitTo: 10}}</button>
								<button type="button" class="btn btn-xs btn-default"><i class="glyphicon glyphicon-map-marker"></i></button>
								<button type="button" class="btn btn-xs btn-default" ng-cloak>{{trip.end_place| limitTo: 10}}</button>
							</div>

							<div class="btn-group" role="group">
								<button type="button" class="btn btn-xs btn-default" ng-if="trip.start_time < 12" ng-cloak>{{trip.start_time | number : 2}} AM</button>
								<button type="button" class="btn btn-xs btn-default" ng-if="trip.start_time >= 12" ng-cloak>{{trip.start_time - 12  | number : 2}} PM</button>
								<button type="button" class="btn btn-xs btn-default"><i class="fa fa-clock-o"></i></button>
								<button type="button" class="btn btn-xs btn-default" ng-if="trip.end_time < 12" ng-cloak>{{trip.end_time | number : 2}} AM</button>
								<button type="button" class="btn btn-xs btn-default" ng-if="trip.end_time >= 12" ng-cloak>{{trip.end_time - 12  | number : 2}} PM</button>
							</div>
						</td>
						<td>
							<div class="btn-group">
								<button type="button" class="btn btn-xs btn-grey"><i class="icon-user"></i></button>
								<button type="button" class="btn btn-xs btn-default" ng-cloak>{{trip.driver_name| limitTo: 10}} | {{trip.driver_phone}}</button>
							</div>
							<div class="btn-group">
								<button type="button" class="btn btn-xs btn-grey"><i class="fa fa-car"></i></button>
								<button type="button" class="btn btn-xs btn-default" ng-cloak>{{trip.vehicle_type}} | {{trip.vehicle_regNo}}</button>
							</div>
						</td>
						<td>
							<div class="btn-group pull-right margin-right-10">
								<button type="button" class="btn btn-xs btn-grey"><i class="fa fa-male"></i></button>

								<button title="No of Travellers" type="button" class="btn btn-xs btn-default"  ng-cloak>{{trip.passengers.length}}</button>
								<button title="Travellers Info" type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
									<span class="caret"></span>
									<span class="sr-only">Toggle Dropdown</span>
								</button>
								<ul class="dropdown-menu">
									<li><a href="#" ng-repeat="passenger in trip.passengers" ng-cloak><i ng-class="passenger.gender == 0 ? 'fa fa-female' : 'fa fa-male'"></i> {{passenger.name}} | {{passenger.phone}}</a></li>
								</ul>
							</div>
						</td>
					</tr>
					</tbody>
				</table>

				<div class="btn-group pull-right" role="group">
					<label class="btn btn-default btn-u-sm" ng-click="prevPage()"><i class="fa fa-angle-double-left"></i></label>
					<label class="btn btn-default btn-u-sm" ng-cloak style="cursor:default; background-color:#fff">
						<span style="font-size:12px; ">Page </span><input type="text" class="btn btn-xs btn-default" ng-model="page" style="width: 40px;height:18px" ng-change="goTOPage()"/><span style="font-size:12px"> of {{total}}</span></label>
					<label class="btn btn-default btn-u-sm " ng-cloak style="cursor:default; background-color:#fff">
						<span style="font-size:12px;">Showing {{(page-1) * size +1 }} - {{(page-1)*size + trips.length}} of {{records}}</span>
					</label>
					<label class="btn btn-default btn-u-sm" ng-click="nextPage()"><i class="fa fa-angle-double-right"></i></label>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal fade download-div" tabindex="-1" role="dialog" aria-labelledby="DownloadTrips" aria-hidden="true">
	<div class="modal-dialog modal-md">
		<div class="modal-content margin-bottom-5">
			<form action="@com.mbrdi.anita.dashboard.controller.routes.DashboardController.downloadTrips()" method="post">
				<div class="modal-header">
					<button aria-hidden="true" data-dismiss="modal" class="close" type="button">
						<i class="fa fa-times"></i>
					</button>
					<h4 class="modal-title">
						<i class="icon-cloud-download"></i> @Messages("Download Trips")
					</h4>
				</div>

				<div class="modal-body">
					<!-- <div class="form-group">
						<label class="col-md-3 control-label text-right">Trip Type</label>
						<div class="col-md-3">
							<fieldset>
								<select name="trip_type" class="form-control">
                                    <option value="ALL">All</option>
									<option value="TO">To</option>
									<option value="FRO">Fro</option>
								</select>
							</fieldset>
						</div>
					</div>
					<div class="margin-bottom-10"></div> -->

					<div class="form-group">
						<label class="col-md-3 control-label text-right"><font color="red">*</font>Date Range</label>
						<div class="col-md-4">
							<input name="st_date" type="text" class="form-control datepicker start_date" placeholder="Start Date" required>
						</div>
						<div class="col-md-1">
							<a><i class="fa fa-long-arrow-right" style="font-size: 25px; text-align: center;"></i></a>
						</div>
						<div class="col-md-4">
							<input name="ed_date" type="text" class="form-control datepicker end_date" placeholder="End Date" required>
						</div>
					</div>
				</div>
				<div class="margin-bottom-20"></div>
				<div class="modal-footer">
					<button class="btn-u btn-u-green" style="margin-bottom: 10px; margin-left: 15px" type='submit'>
						<i class="fa  fa-file-excel-o"></i> @Messages("Download")
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script type="text/javascript">

var app = angular.module('tripsApp', []);

app.controller('tripsCtl', function($scope, $timeout, $http, $q) {

	$scope.trips = [];
	$scope.page = 1;
	$scope.size = 20;
	$scope.total = 0;
	$scope.from_date = "From Date";
    $scope.to_date = "To Date";
    $scope.filter_route = "All Trips";

	$scope.trip = null;
	$scope.value = null;
	$scope.records=0;

	$scope.base_url = window.location.protocol + "//"+window.location.host+"/trip/data?_search=true&rows="+$scope.size;
	$scope.url_filter="";
    $scope.current_status = 'all';

	$scope.fetchData = function(url, page){
        if(url != undefined && url != null){
            url = $scope.base_url + url;
        } else {
            url = $scope.base_url;
        }
        showLoader();
        $http.get( url + "&page=" + page).success(function(response) {
            $scope.trips = response.rows;
            $scope.page = response.page;
            $scope.total = response.total;
            $scope.records = response.records;
            hideLoader();
        }).error(function() {
            hideLoader();
        });

	}

    $scope.nextPage = function (){
        if($scope.trips != null && $scope.trips.length == $scope.size && $scope.page +1 <= $scope.total){
            $scope.fetchData($scope.url_filter, $scope.page +1);
        }
    }

    $scope.prevPage = function (){
        if($scope.page >1){
            $scope.fetchData($scope.url_filter, $scope.page -1);
        }
    }

    $scope.goTOPage = function (){
        if($scope.page != null && $scope.page != "" && $scope.page <= $scope.total){
            $scope.fetchData($scope.url_filter, $scope.page);
        }
    }

    $scope.refreshGrid = function(){
        $('#filter_from_date').val("");
        $scope.url_filter = "";
        $scope.route_name = "";
        $scope.filterData("");
    }

    $scope.getDateFormatted = function(date){
        var date = date.toString();
        return date.substring(0, 4) + "-" + date.substring(4, 6) + "-" + date.substring(6,8);
    }

    $scope.filterAll = function(){

        $scope.page = 1;
        var url = "";

        if($('#filter_from_date').val() != null){
            var from_date = $('#filter_from_date').val();
            $scope.from_date = from_date;
            from_date = from_date.replace('-', '');
            from_date = from_date.replace('-', '');
            url = url + "&from_date=" + parseInt(from_date);
        }

        $scope.url_filter = url;
        $scope.fetchData(url, $scope.page);
    }

	$scope.filterData = function(url){
		if(url != "" && url != undefined){
			$scope.fetchData(url, $scope.page);
		} else {
			var today = new Date();
			var mm = today.getMonth()+1; //January is 0!
			var yyyy = today.getFullYear();
			var day = today.getDate();

			if(mm<10) {
				mm='0'+mm;
			}

			if(day<10) {
				day='0'+day;
			}

			var st_d = yyyy + '-' + mm + '-' + day;

			$scope.page = 1;

			$('#filter_from_date').val(st_d);
			st_d = st_d.replace('-', '');
			st_d = st_d.replace('-', '');

			url = "&from_date=" + parseInt(st_d);
			$scope.url_filter = url;

			$scope.fetchData(url, $scope.page);
		}
	}

    $scope.filterData($scope.url_filter);

});
</script>

@views.html.basic.footer()
